---
layout: post
category : technology
tags : [key-value , redis , doc ]
title: 键值对缓存设计
date : 2014-08-10
---


> 背景

  * 由于频繁关系查询及人员信息的使用，采用原有数据库查询方式在用户量增加时数据查询会减慢。

  * 针对现有订单中心及物流跟踪的展现模式，频繁的统计查询，关联太多数据，查询较慢。

  * 针对上述情况采用内存将频繁使用数据或统计数据缓存。满足大用户量的查询等操作。
      为满足集群及分布式部署，采用内存数据库redis作为内存数据的载体。

> 关系数据内存格式定义

  * 频繁使用数据

    > 用户信息

    基于用户主键(user_id)，储存要求的数据。

    格式 （自定义关键字：用户主键值：字段名）

    e.g   user:0001:name = zxh

    > 公司参数

    基于公司主键(corp_id),存储要求的参数数据。

    格式（自定义关键字：公司主键：参数字段）

    e.g   corp:0001:isfuture = false

    > 用户验证

    用户校验用户是否合法，基于用户编码。

    格式（自定义关键字：用户编码值：密码值=有效无效）

    e.g    auth:xfcs:1a = 0

  * 人员订单范围划分

    > 人员与调度组织关系

      用户所对应的调度组织集合。基于用户主键和类型。

      格式（自定义关键字：用户主键值：类型值 = 调度组织集合）

      e.g     rept:0001:001 = set<String>[dispatch_id]

    > 市场区域与调度组织关系

      市场区域对应的调度组织的关系。基于调度主键。

      格式（自定义关键字：调度主键值=市场区域集合）

      e.g     rerd:0001 = set<String>[region_id]

  * 统计数据分步实现

    > 订单相关信息

      记录订单不同过程状态信息，基于订单主键。

      格式（自定义关键字：订单主键：信息字段=字段值）

      e.g   order：0001：banace_quantity  = 100

    > 订单按调度组织分布

      记录该分类对应调度组织的所属订单主键，基于统计类型和订单类型。

      格式（自定义关键字：未分仓：调度组织主键 = set<String>[order_id]）

      e.g  ordd:weifencang:0001 =  set<String>[order_id]  

    > 调度组织与市场区域关系

      记录市场区域对应调度组织的关系，基于市场区域主键。

      格式（自定义关键字：区域主键 = 调度组织）

      e.g    redr:0001 = 0001

3.设计原则

  * 所有取数原则采用优先内存数据库，失败取mysql原始数据。

  * 针对缓存设置失效时间，节约内存。

  * 透明化调用，尽量避免直接调用。

  * 内存取值与数据库取值设定控制阀。

4.详细设计

  * 人员订单范围划分

    >  通过人员与调度类型确定其管辖的调度组织，在通过调度组织与区域关系确定其区域，最后合集得到人员在此类型下所能看到的区域范围。从而确定订单范围。

    >  查询基于现有逻辑，查询条件做相应替换。

  * 统计数据分步实现

    > 统计数据分步实现是针对原有实现方案的改进方案。

    > 统计数据分步的关键点在于将原先分布在多张表的数据统计数据在数据录入的时候便做相应的逻辑处理。

    > 主要通过缓存未处理完的每张订单的详细数据。主要包括：订单主键、调度组织主键、分仓总数量、配车总数量、提货总数量。

    > 针对不同类型的统计数据，存储订单主键，在改变订单详细数据时同步更新对应的统计数据。

    > 可采用人员与调度类型所确定的调度组织对应的订单主键集合，根据对应集合获取查询结果集。
