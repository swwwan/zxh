---
layout: post
category : technology
tags : [login,design ]
title: 登录方案设计
date : 2014-08-14
---


> 背景描述

  由于HTTP协议的无状态性，同时由于程序访问的私密性，对于每次的访问都因有所校验。出于正常的思维考虑
  采用服务器分配密钥的形式，存储本地，每次访问校验的方式实现请求的安全与方便。

> 基本名称解释

  * 来源类型：请求的来源分布，用于实现多类客户端同时登录。
  * 登录序列：服务器端分配给客户端的密钥，用于安全访问，同时可用于盗用行为检测。
  * 登录令牌：服务器端为每个session访问期间分配的值。用于实现单实例访问。
  * 口令登录：采用用户名+密码的方式登录。

> 登录状态设计

  * 数据表结构

    字段：来源类型、用户编码（唯一）、登录序列

  * 服务器内存结构

    字段：来源类型、用户编码、登录序列、登录令牌、登录IP、IP错误累计

  * 客户端存储结构（cookies/localstorage）

    字段：用户编码、登录序列、登录令牌

> 具体实现方案

  * 用户编码明文在客户端明文存储，登录序列、登录令牌为MD5散列随机数。
  * 采用登录用户编码与登录序列登录，服务器端更新登录令牌，并将更新值返回客户端。
  * 采用口令登录更新客户端登录序列、登录令牌。服务器若没有自动生成保存，若有则直接返给客户端。（此处无需更新登录令牌是由于
    口令只有真正用户持有。）
  * 若无口令登录且IP多次切换则说明客户端存储数据被盗，应清除服务器端登录序列与登录令牌。强制用户重新输入口令。
  * 用户登录session中访问校验登录序列与登录令牌即可，若发现登录令牌不同，可说明用其他用非口令方式登录，若IP不同则要校验是非
    客户端存储被盗取。

> 逻辑实现

  * 口令登录

      {% blockquote %}

        校验用户名密码。
        success:
        	查询登录序列，登录令牌。
        		有，更新客户端数据。
        		无，重新生成，并更新客户端数据。
        fail:
        	返回错误原因。

      {% endblockquote %}

  * 登录序列登录（自动登录等）

      {% blockquote %}

        校验序列码。
        success：
        	重新生成登录令牌，返回客户端。
        fail:
        	返回错误信息。
        
      {% endblockquote %}

  * 请求校验

      {% blockquote %}

        校验登录序列、登录令牌。
        success：
        	通过
        fail:
        	校验登录序列。
        		success:多实例运行，校验IP是否相同，
        			不同：强制重新登录。
        			相同：更新客户端登录令牌。
        		fail:强制重新登录。

      {% endblockquote %}

> 引用文档

  * [你会做Web上的用户登录功能吗？](http://coolshell.cn/articles/5353.html)
  * [The definitive guide to form based website authentication](http://stackoverflow.com/questions/549/the-definitive-guide-to-form-based-website-authentication)
